<!DOCTYPE html>
<html>
  <head>
    <title>Financial Report</title>
    <style>
      body {
        font-family: "Lucida Sans Unicode", "Lucida Grande", sans-serif;
        font-size: 14px;
        margin: 0;
        padding: 10px;
      }
      table {
        border-collapse: collapse;
        width: 100%;
        border: 1px solid black;
      }
      th,
      td {
        border: 1px solid black;
        padding: 8px;
        text-align: left;
      }
      th {
        background-color: #17d1a3ff;
        position: sticky;
        top: 0;
      }
      td.currency {
        text-align: right;
      }
      tr:nth-child(even) {
        background-color: #f2f2f2;
      }
      .null-value {
        color: #999;
        font-style: italic;
      }

      /* Chart styles */
      #chartContainer {
        display: none;
        margin-top: 30px;
        padding: 20px;
        background-color: #f9f9f9;
        border: 1px solid #ddd;
      }
      #chartContainer.visible {
        display: block;
      }
      #chartContainer h3 {
        margin-top: 0;
        margin-bottom: 15px;
      }
      .bar-chart {
        display: flex;
        align-items: flex-end;
        gap: 2px;
        height: 300px;
        padding: 10px;
        padding-top: 60px;
        background-color: white;
        border: 1px solid #ddd;
        overflow-x: auto;
        position: relative;
      }
      .bar-item {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 5px;
        height: 100%;
        justify-content: flex-end;
        position: relative;
        min-width: 20px;
      }
      .bar-wrapper {
        width: 100%;
        border: 1px solid black;
        transition: filter 0.3s ease;
        position: relative;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .bar-wrapper:hover {
        filter: brightness(0.85);
      }
      .bar-info {
        font-size: 11px;
        font-weight: bold;
        text-align: center;
        opacity: 0;
        transition: opacity 0.2s ease;
        white-space: nowrap;
        background-color: rgba(0, 0, 0, 0.85);
        color: white;
        padding: 5px 8px;
        border-radius: 4px;
        z-index: 10;
        pointer-events: none;
      }
      .bar-item:hover .bar-info {
        opacity: 1;
      }

      /* Plain button - no custom styling */
      #toggleChartBtn {
        margin-top: 20px;
        margin-bottom: 15px;
      }
    </style>
  </head>
  <body>
    <table>
      <thead>
        <tr>
          <th>VAMC ID</th>
          <th>Date</th>
          <th>Department</th>
          <th>Vendor</th>
          <th>Account</th>
          <th>Contract #</th>
          <th>Requestor</th>
          <th>Approver</th>
          <th>Committed Estimated Cost</th>
          <th>Transaction Amount</th>
        </tr>
      </thead>
      <tbody id="reportTableBody">
        <!-- Data will be inserted here by JavaScript -->
      </tbody>
    </table>

    <button id="toggleChartBtn">Show Chart ðŸ“Š</button>

    <div id="chartContainer">
      <h3>Transaction Amounts by Site</h3>
      <div id="barChart" class="bar-chart"></div>
    </div>

    <script>
      // Helper function to format currency
      function formatCurrency(amount) {
        if (amount === null || amount === undefined || amount === 0)
          return "$0.00";
        return (
          "$" +
          parseFloat(amount).toLocaleString("en-US", {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2,
          })
        );
      }

      // Function to generate unique colors using HSL
      function getUniqueColor(index, total) {
        // Use golden ratio to distribute hues evenly
        const goldenRatio = 0.618033988749895;
        const hue = (index * goldenRatio * 360) % 360;

        // Use varying saturation and lightness for more variety
        const saturation = 60 + (index % 3) * 15; // 60%, 75%, 90%
        const lightness = 50 + (index % 2) * 10; // 50%, 60%

        return `hsl(${hue}, ${saturation}%, ${lightness}%)`;
      }

      // Load data from sessionStorage
      const dataJson = sessionStorage.getItem("financialReportData");

      if (dataJson) {
        const data = JSON.parse(dataJson);
        const tbody = document.getElementById("reportTableBody");

        // Populate table
        data.forEach((row) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
          <td>${
            row.station_number || '<span class="null-value">N/A</span>'
          }</td>
          <td>${
            row.date_of_request
              ? new Date(row.date_of_request).toLocaleDateString("en-US")
              : '<span class="null-value">N/A</span>'
          }</td>
          <td>${
            row.requesting_service || '<span class="null-value">N/A</span>'
          }</td>
          <td>${row.vendor || '<span class="null-value">N/A</span>'}</td>
          <td>${row.cost_center || '<span class="null-value">N/A</span>'}</td>
          <td>${
            row.purchase_order_obligation_no ||
            '<span class="null-value">N/A</span>'
          }</td>
          <td>${
            row.originator_of_request || '<span class="null-value">N/A</span>'
          }</td>
          <td>${
            row.approving_official || '<span class="null-value">N/A</span>'
          }</td>
          <td class="currency">${formatCurrency(
            row.Committed_Estimated_Cost
          )}</td>
          <td class="currency">${formatCurrency(row.Transaction_Amount)}</td>
        `;
          tbody.appendChild(tr);
        });

        // Calculate totals by site (excluding grand total rows)
        const siteTotals = {};
        data.forEach((row) => {
          const site = row.station_number;

          // Skip if site is null, 'N/A', or contains 'total', 'grand', or '---'
          if (
            !site ||
            site === "N/A" ||
            String(site).toLowerCase().includes("total") ||
            String(site).toLowerCase().includes("grand") ||
            String(site).includes("---")
          ) {
            return;
          }

          const amount = parseFloat(row.Transaction_Amount) || 0;

          if (!siteTotals[site]) {
            siteTotals[site] = 0;
          }
          siteTotals[site] += amount;
        });

        // Create chart
        const chartDiv = document.getElementById("barChart");

        if (Object.keys(siteTotals).length === 0) {
          chartDiv.innerHTML = "<p>No site data available for chart</p>";
        } else {
          const maxValue = Math.max(...Object.values(siteTotals));
          const minValue = Math.min(...Object.values(siteTotals));

          // Use a range that starts slightly below the minimum to avoid flat bars
          const rangeMin = minValue * 0.5; // Start at 50% of minimum value
          const range = maxValue - rangeMin;

          // Sort by site number
          const sortedSites = Object.entries(siteTotals).sort((a, b) => {
            const numA = parseInt(a[0]) || 0;
            const numB = parseInt(b[0]) || 0;
            return numA - numB;
          });

          const totalBars = sortedSites.length;

          sortedSites.forEach(([site, total], index) => {
            const barItem = document.createElement("div");
            barItem.className = "bar-item";

            // Calculate height as percentage using the adjusted range
            const heightPercentage =
              range > 0 ? ((total - rangeMin) / range) * 100 : 50;

            // Ensure minimum visible height
            const finalHeight = Math.max(heightPercentage, 5);

            // Get unique color for this bar
            const barColor = getUniqueColor(index, totalBars);

            barItem.innerHTML = `
            <div class="bar-wrapper" style="height: ${finalHeight}%; background-color: ${barColor};">
              <div class="bar-info">Site ${site}<br>${formatCurrency(
              total
            )}</div>
            </div>
          `;

            chartDiv.appendChild(barItem);
          });
        }

        // Toggle chart visibility
        const toggleBtn = document.getElementById("toggleChartBtn");
        const chartContainer = document.getElementById("chartContainer");

        toggleBtn.addEventListener("click", function () {
          chartContainer.classList.toggle("visible");
          if (chartContainer.classList.contains("visible")) {
            toggleBtn.textContent = "Hide Chart";
          } else {
            toggleBtn.textContent = "Show Chart ðŸ“Š";
          }
        });

        // Clear the data from sessionStorage after use
        sessionStorage.removeItem("financialReportData");
      } else {
        document.getElementById("reportTableBody").innerHTML =
          '<tr><td colspan="10">No data available</td></tr>';
      }
    </script>
  </body>
</html>
