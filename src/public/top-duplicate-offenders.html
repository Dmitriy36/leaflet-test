<!doctype html>
<html>
  <head>
    <title>Top Duplicate Offenders Report</title>
    <style>
      body {
        font-family: "Lucida Sans Unicode", "Lucida Grande", sans-serif;
        font-size: 1em;
        padding: 20px;
      }

      .controls {
        margin-bottom: 20px;
        padding: 15px;
        background-color: #f5f5f5;
        border: 1px solid #ddd;
      }

      .controls label {
        font-weight: bold;
        margin-right: 10px;
      }

      .controls select {
        padding: 5px;
        margin-right: 15px;
      }

      .controls button {
        padding: 5px 15px;
        cursor: pointer;
      }

      table {
        border-collapse: collapse;
        width: 100%;
      }

      th,
      td {
        border: 1px solid black;
        padding: 8px;
        text-align: left;
      }

      th {
        background-color: #17d1a3ff;
        position: sticky;
        top: 0;
      }

      tr:nth-child(even) {
        background-color: #f2f2f2;
      }

      .patient-name {
        width: 25%;
      }

      .number-cell {
        text-align: right;
      }

      .red-item {
        color: red;
      }
    </style>
    <script>
      let currentData = [];

      window.onload = function () {
        loadData();
      };

      function loadData() {
        const data = JSON.parse(
          sessionStorage.getItem("topDuplicateOffendersData"),
        );
        currentData = data;
        displayData(data);
      }

      function displayData(data) {
        const tableBody = document.getElementById("tableBody");
        tableBody.innerHTML = ""; // Clear existing rows

        if (!data || data.length === 0) {
          tableBody.innerHTML =
            '<tr><td colspan="5">No duplicate offenders found</td></tr>';
          return;
        }

        data.forEach((row) => {
          // Format the item IENs with red color
          let itemsDisplay = "N/A";
          if (row.DuplicateItemIENs) {
            const items = row.DuplicateItemIENs.split(", ");
            const redItems = items
              .map((item) => `<span class="red-item">${item}</span>`)
              .join(", ");
            itemsDisplay = `Items: ${redItems}`;
          }

          tableBody.innerHTML += `
    <tr>
      <td>${row.PatShortSSN || "N/A"}</td>
      <td class="patient-name">${row.PatientName || "N/A"}</td>
      <td class="number-cell">${row.TotalDuplicateIssues || 0} (${itemsDisplay})</td>
      <td class="number-cell">${row.TotalStationsInvolved || 0}</td>
      <td><button onclick="window.opener.APAT_GetOffenderDetails('${row.PatShortSSN}')">View Details</button></td>
    </tr>
  `;
        });
      }

      async function refreshData() {
        const months = document.getElementById("monthsSelect").value;

        try {
          const response = await fetch(
            `/top-duplicate-offenders?months=${months}`,
          );
          const data = await response.json();

          currentData = data.data;
          sessionStorage.setItem(
            "topDuplicateOffendersData",
            JSON.stringify(data.data),
          );
          displayData(data.data);
        } catch (error) {
          console.error("Error refreshing data:", error);
          alert("Error loading data. Please try again.");
        }
      }
    </script>
  </head>
  <body>
    <h2>Top Duplicate Offenders Report</h2>

    <div class="controls">
      <label for="monthsSelect">Look back period:</label>
      <select id="monthsSelect">
        <option value="1">1 month</option>
        <option value="3">3 months</option>
        <option value="6">6 months</option>
        <option value="12" selected>12 months</option>
        <option value="18">18 months</option>
        <option value="24">24 months</option>
        <option value="36">36 months</option>
        <option value="48">48 months</option>
        <option value="60">60 months</option>
      </select>
      <button onclick="refreshData()">Refresh</button>
    </div>

    <table>
      <thead>
        <tr>
          <th>Patient SSN</th>
          <th class="patient-name">Patient Name</th>
          <th>Total Duplicate Issues</th>
          <th>Total Stations Involved</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
  </body>
</html>
