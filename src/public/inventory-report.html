<!DOCTYPE html>
<html>
  <head>
    <title>Inventory Report</title>
    <style>
      body {
        font-family: "Lucida Sans Unicode", "Lucida Grande", sans-serif;
        font-size: 14px;
        margin: 0;
        padding: 10px;
      }
      .search-container {
        margin-bottom: 20px;
        padding: 15px;
        background-color: #f5f5f5;
        border: 1px solid #ddd;
      }
      .search-row {
        margin-bottom: 10px;
      }
      .search-row label {
        font-weight: bold;
      }
      #searchInput {
        width: 300px;
        padding: 5px;
        margin-left: 10px;
      }
      #searchBtn {
        padding: 5px 15px;
        margin-left: 10px;
        cursor: pointer;
      }
      .radio-group {
        margin-left: 10px;
      }
      .radio-group label {
        margin-left: 10px;
        font-weight: normal;
      }
      table {
        border-collapse: collapse;
        width: 100%;
        border: 1px solid black;
      }
      th,
      td {
        border: 1px solid black;
        padding: 8px;
        text-align: left;
      }
      th {
        background-color: #17d1a3ff;
        position: sticky;
        top: 0;
      }
      td.number {
        text-align: right;
      }
      tr:nth-child(even) {
        background-color: #f2f2f2;
      }
      .null-value {
        color: #999;
        font-style: italic;
      }
      .message {
        padding: 20px;
        text-align: center;
        color: #666;
      }
      .error {
        color: red;
      }
    </style>
  </head>
  <body>
    <div class="search-container">
      <div class="search-row">
        <input
          type="text"
          id="searchInput"
          placeholder="Enter item number..."
        />
        <button id="searchBtn">Search</button>
      </div>
      <div class="search-row">
        <label>Search by:</label>
        <span class="radio-group">
          <label>
            <input type="radio" name="searchType" value="number" checked />
            Item Number
          </label>
          <label>
            <input
              type="radio"
              name="searchType"
              value="description"
              disabled
            />
            Description (coming soon)
          </label>
        </span>
      </div>
    </div>

    <table>
      <thead>
        <tr>
          <th>Station ID</th>
          <th>Location</th>
          <th>Item Number</th>
          <th>Quantity</th>
        </tr>
      </thead>
      <tbody id="reportTableBody">
        <tr>
          <td colspan="4" class="message">
            Enter an item number and click Search
          </td>
        </tr>
      </tbody>
    </table>

    <script>
      // Get selected VAMC IDs from opener window (parent page)
      function getSelectedVAMCs() {
        // You'll need to pass this from your main page
        // For now, returning example - replace with your actual logic
        if (window.opener && window.opener.getSelectedVAMCIds) {
          return window.opener.getSelectedVAMCIds();
        }
        // Fallback: you can also pass via URL parameter
        const urlParams = new URLSearchParams(window.location.search);
        const vamcIds = urlParams.get("vamc_ids");
        return vamcIds ? vamcIds.split(",") : [];
      }

      function searchInventory() {
        const itemNumber = document.getElementById("searchInput").value.trim();
        const tbody = document.getElementById("reportTableBody");

        // Validation
        if (!itemNumber) {
          tbody.innerHTML =
            '<tr><td colspan="4" class="message error">Please enter an item number</td></tr>';
          return;
        }

        // Get VAMC IDs
        const vamcIds = getSelectedVAMCs();
        if (!vamcIds || vamcIds.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="4" class="message error">No stations selected. Please select stations from the main page.</td></tr>';
          return;
        }

        // Show loading message
        tbody.innerHTML =
          '<tr><td colspan="4" class="message">Searching...</td></tr>';

        // Build API URL
        const vamcIdsString = vamcIds.join(",");
        const url = `/api/item-inventory?item_number=${encodeURIComponent(
          itemNumber
        )}&vamc_ids=${vamcIdsString}`;

        // Make API call
        fetch(url)
          .then((response) => {
            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
          })
          .then((data) => {
            console.log("Received data:", data);

            if (!data || !data.data || !Array.isArray(data.data)) {
              throw new Error("Invalid data structure");
            }

            if (data.data.length === 0) {
              tbody.innerHTML =
                '<tr><td colspan="4" class="message">No results found</td></tr>';
              return;
            }

            // Clear table and populate with results
            tbody.innerHTML = "";
            data.data.forEach((row) => {
              const tr = document.createElement("tr");
              tr.innerHTML = `
                <td>${
                  row.Station_Id || '<span class="null-value">N/A</span>'
                }</td>
                <td>${
                  row.Location || '<span class="null-value">N/A</span>'
                }</td>
                <td>${
                  row.Item_Number || '<span class="null-value">N/A</span>'
                }</td>
                <td class="number">${
                  row.Quantity !== null && row.Quantity !== undefined
                    ? row.Quantity
                    : '<span class="null-value">N/A</span>'
                }</td>
              `;
              tbody.appendChild(tr);
            });
          })
          .catch((error) => {
            console.error("Error fetching inventory:", error);
            tbody.innerHTML = `<tr><td colspan="4" class="message error">Error loading data: ${error.message}</td></tr>`;
          });
      }

      // Add event listener
      document
        .getElementById("searchBtn")
        .addEventListener("click", searchInventory);
    </script>
  </body>
</html>
