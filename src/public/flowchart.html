<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>System Architecture Flowchart</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Courier New", Courier, monospace;
        background: #c0c0c0;
        min-height: 100vh;
        padding: 20px;
        display: flex;
        justify-content: center;
        align-items: center;
        zoom: 175%;
      }

      .container {
        background: #ffffff;
        border: 3px solid #000000;
        padding: 30px;
        max-width: 1200px;
        width: 100%;
      }

      h1 {
        text-align: center;
        color: #000000;
        margin-bottom: 10px;
        font-size: 2em;
        font-weight: bold;
        text-decoration: underline;
      }

      .subtitle {
        text-align: center;
        color: #000000;
        margin-bottom: 40px;
        font-size: 1.1em;
      }

      .diagram {
        display: flex;
        flex-direction: column;
        gap: 0px;
        margin: 40px 0;
      }

      .row {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 20px;
        position: relative;
      }

      .box {
        background: #ffff99;
        color: #000000;
        padding: 30px 40px;
        border: 3px solid #000000;
        text-align: center;
        min-width: 200px;
        cursor: pointer;
        position: relative;
      }

      .box:hover {
        background: #ffff66;
      }

      .box:active {
        border-style: inset;
      }

      .box-title {
        font-size: 1.3em;
        font-weight: bold;
        margin-bottom: 8px;
      }

      .box-desc {
        font-size: 0.9em;
      }

      .user-box {
        background: #ff99cc;
      }

      .user-box:hover {
        background: #ff66b2;
      }

      .frontend-box {
        background: #99ccff;
      }

      .frontend-box:hover {
        background: #66b2ff;
      }

      .backend-box {
        background: #99ff99;
      }

      .backend-box:hover {
        background: #66ff66;
      }

      .db-box {
        background: #ffcc99;
      }

      .db-box:hover {
        background: #ffb266;
      }

      .arrow-down {
        display: flex;
        justify-content: center;
        font-size: 1.5em;
        color: #000000;
        font-weight: bold;
        line-height: 0.8;
      }

      .flow-container {
        position: relative;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0px;
        padding: 5px 0;
      }

      .flow-arrow {
        display: flex;
        align-items: center;
        gap: 10px;
        position: relative;
      }

      .flow-label {
        background: #ffffff;
        color: #000000;
        padding: 12px 24px;
        border: 3px solid #000000;
        font-size: 0.9em;
        font-weight: bold;
        max-width: 600px;
        position: relative;
      }

      .flow-label.request {
        background: #ccccff;
      }

      .flow-label.response {
        background: #ccffcc;
      }

      .arrow-graphic {
        font-size: 1.5em;
        color: #000000;
        font-weight: bold;
        line-height: 0.8;
      }

      .flow-separator {
        font-size: 1.5em;
        color: #000000;
        font-weight: bold;
        line-height: 0.8;
      }

      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        z-index: 2000;
        justify-content: center;
        align-items: center;
      }

      .modal.active {
        display: flex;
      }

      .modal-content {
        background: #ffffff;
        padding: 40px;
        border: 3px solid #000000;
        max-width: 600px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
        position: relative;
      }

      .modal-close {
        position: absolute;
        top: 10px;
        right: 10px;
        background: #c0c0c0;
        border: 2px solid #000000;
        width: 30px;
        height: 30px;
        font-size: 1.5em;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
      }

      .modal-close:hover {
        background: #808080;
      }

      .modal-close:active {
        border-style: inset;
      }

      .modal-title {
        font-size: 2em;
        color: #000000;
        margin-bottom: 20px;
        padding-right: 40px;
        font-weight: bold;
        text-decoration: underline;
      }

      .modal-section {
        margin: 20px 0;
      }

      .modal-section h3 {
        color: #000000;
        margin-bottom: 10px;
        font-size: 1.2em;
        font-weight: bold;
        text-decoration: underline;
      }

      .modal-section ul {
        list-style: none;
        padding-left: 0;
      }

      .modal-section li {
        padding: 8px 0;
        color: #000000;
        border-bottom: 1px solid #000000;
      }

      .modal-section li:last-child {
        border-bottom: none;
      }

      .modal-section li:before {
        content: "> ";
        font-weight: bold;
        margin-right: 8px;
      }

      .code-block {
        background: #f0f0f0;
        padding: 15px;
        border: 2px solid #000000;
        font-family: "Courier New", monospace;
        font-size: 0.85em;
        color: #000000;
        margin: 10px 0;
      }

      .click-hint {
        text-align: center;
        color: #000000;
        font-size: 0.9em;
        margin-top: 20px;
        font-weight: bold;
      }

      .features {
        background: #e0e0e0;
        border: 3px solid #000000;
        padding: 30px;
        margin-top: 40px;
      }

      .features h2 {
        color: #000000;
        margin-bottom: 20px;
        text-align: center;
        font-weight: bold;
        text-decoration: underline;
      }

      .feature-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-top: 20px;
      }

      .feature-item {
        background: #ffffff;
        padding: 20px;
        border: 2px solid #000000;
      }

      .feature-item h3 {
        color: #000000;
        margin-bottom: 10px;
        font-size: 1.1em;
        font-weight: bold;
        text-decoration: underline;
      }

      .feature-item ul {
        list-style: none;
        padding-left: 0;
      }

      .feature-item li {
        padding: 5px 0;
        color: #000000;
        font-size: 0.95em;
      }

      .feature-item li:before {
        content: "* ";
        font-weight: bold;
        margin-right: 8px;
      }

      @media (max-width: 768px) {
        .container {
          padding: 20px;
        }

        h1 {
          font-size: 1.5em;
        }

        .box {
          min-width: 140px;
          padding: 20px 25px;
        }

        .feature-grid {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Application Architecture</h1>
      <p class="subtitle">How the Integration Project App Works</p>

      <div class="diagram">
        <!-- User Layer -->
        <div class="row">
          <div class="box user-box">
            <div class="box-title">VA User</div>
          </div>
        </div>

        <div class="arrow-down">│</div>
        <div class="arrow-down">│</div>
        <div class="arrow-down">│</div>
        <div class="arrow-down">▼</div>

        <!-- Frontend Layer -->
        <div class="row">
          <div class="box frontend-box">
            <div class="box-title">Web Pages</div>
            <div class="box-desc">HTML + frontend .js</div>
          </div>
        </div>

        <!-- Request/Response Flow -->
        <div class="flow-container">
          <div class="flow-label request">
            Example request: "search for item #12345"
          </div>

          <div
            style="
              display: flex;
              gap: 20px;
              font-size: 1.5em;
              font-weight: bold;
              line-height: 0.8;
            "
          >
            <div>
              <div>│</div>
              <div>▼</div>
            </div>
            <div>
              <div>▲</div>
              <div>│</div>
            </div>
          </div>

          <div class="flow-label response">
            Example response: "here's the inventory data"
          </div>
        </div>

        <!-- Backend Layer -->
        <div class="row">
          <div class="box backend-box">
            <div class="box-title">API Layer</div>
            <div class="box-desc">server.js</div>
          </div>
        </div>

        <!-- Query/Data Flow -->
        <div class="flow-container">
          <div class="flow-label request">
            Example stored procedure call SP_InventoryCheck (12345) "Get
            inventory for item #12345"
          </div>

          <div
            style="
              display: flex;
              gap: 20px;
              font-size: 1.5em;
              font-weight: bold;
              line-height: 0.8;
            "
          >
            <div>
              <div>│</div>
              <div>▼</div>
            </div>
            <div>
              <div>▲</div>
              <div>│</div>
            </div>
          </div>

          <div class="flow-label response">
            Central RDS Database: populated nightly via AWS Lambda function
            calls (AWS Python SDK), followed by aggregation jobs for pre-defined
            reports.
          </div>
        </div>

        <!-- Database Layer -->
        <div class="row">
          <div class="box db-box">
            <div class="box-title">Database</div>
            <div class="box-desc">db.js + SQL Server</div>
          </div>
        </div>
      </div>

      <div class="features">
        <h2>What Each Component Does</h2>
        <div class="feature-grid">
          <div class="feature-item">
            <h3>Web Pages (Frontend)</h3>
            <ul>
              <li>Inventory search with autocomplete</li>
              <li>Duplicate issues reporting</li>
              <li>Top offenders dashboard</li>
              <li>Clean, simple interface</li>
            </ul>
          </div>
          <div class="feature-item">
            <h3>API Layer (Backend)</h3>
            <ul>
              <li>Handles all API requests</li>
              <li>Security & validation</li>
              <li>Manages timeouts (60 seconds)</li>
              <li>Error handling & logging</li>
            </ul>
          </div>
          <div class="feature-item">
            <h3>Database Layer</h3>
            <ul>
              <li>Stores inventory data</li>
              <li>Logs all transactions (who searched for what and where?)</li>
              <li>Optimized stored procedures</li>
              <li>Connection pooling for speed</li>
            </ul>
          </div>
        </div>
      </div>

      <div class="features" style="margin-top: 20px">
        <h2>Key Features Built</h2>
        <div class="feature-grid">
          <div class="feature-item">
            <h3>Inventory Search</h3>
            <ul>
              <li>Search by item number or description</li>
              <li>Real-time autocomplete suggestions</li>
              <li>Shows all station locations</li>
              <li>Current quantity tracking</li>
            </ul>
          </div>
          <div class="feature-item">
            <h3>Duplicate Issues Report</h3>
            <ul>
              <li>Identify repeat offenders</li>
              <li>Filter by time period (1-60 months)</li>
              <li>Detailed drill-down views</li>
              <li>Multi-station tracking</li>
            </ul>
          </div>
          <div class="feature-item">
            <h3>Performance Optimizations</h3>
            <ul>
              <li>Query time: 98s -> 5s (95% improvement)</li>
              <li>Correct indexing must be maintained</li>
              <li>Connection pooling</li>
              <li>Pre-aggregate before joining</li>
            </ul>
          </div>
        </div>
      </div>
    </div>

    <div class="tooltip" id="tooltip"></div>

    <!-- Modal for detailed information -->
    <div class="modal" id="modal">
      <div class="modal-content">
        <button class="modal-close" onclick="closeModal()">X</button>
        <div id="modal-body"></div>
      </div>
    </div>

    <script>
      // Detailed content for each component
      const componentDetails = {
        user: {
          title: "Business User",
          sections: [
            {
              heading: "Who Uses This System?",
              content: [
                "Inventory managers checking stock levels (on theirs or other VAMC sites)",
                "Auditors reviewing duplicate issues on (on theirs or other VAMC sites)",
                "Inventory managers deciding which stock items to order, in advance (on theirs or other VAMC sites)",
                "Compliance officers tracking patterns",
              ],
            },
            {
              heading: "What Can You Do?",
              content: [
                "Search for items by number or description",
                "View inventory across any VAMC stations",
                "Generate duplicate issues reports",
                "Drill down into details",
                "Export data as CSV or Excel for further analysis and reporting",
              ],
            },
            {
              heading: "Access Method",
              content: [
                "Any modern web browser (Chrome, Edge, Firefox)",
                "Desktop or tablet recommended",
                "No special software installation needed",
                "Security: only accessible from a VA device, is HTTPS, AWS WAF protection (DDoS)",
              ],
            },
          ],
        },
        frontend: {
          title: "Web Pages (Frontend)",
          sections: [
            {
              heading: "Key Pages",
              content: [
                "inventory-report.html - Search items with autocomplete",
                "top-duplicate-offenders.html - Main report dashboard",
                "offender-details.html - Detailed drill-down view",
                "financial-report.html - a sample aggregate report based on VA's Control Point Activity",
              ],
            },
            {
              heading: "Smart Features",
              content: [
                "Autocomplete: Suggestions appear as you type (300ms delay)",
                "Keyboard navigation: Use arrow keys and Enter",
                "Radio buttons: Switch between Item # and Description search",
                "Responsive design: Works on different screen sizes",
                "Session storage: Maintains state between detail views",
              ],
            },
            {
              heading: "Technology Used",
              content: [
                "HTML5 for page structure",
                "frontend.js handles all user interactions",
                "Vanilla JavaScript (no frameworks needed)",
                "Modern CSS for styling",
              ],
            },
            {
              heading: "Example Flow",
              code: `User types "Band" -> frontend.js waits 300ms -> 
Calls /api/search-items -> Shows matching items -> 
User selects "Bandage, 4x4" -> 
Calls /api/item-inventory -> Displays results`,
            },
          ],
        },
        backend: {
          title: "Business Logic (server.js)",
          sections: [
            {
              heading: "API Endpoints Created",
              content: [
                "GET /api/search-items - Autocomplete suggestions",
                "POST /api/item-inventory - Get inventory by item",
                "GET /api/top-duplicate-offenders - Main report",
                "POST /api/offender-details - Detailed patient view",
              ],
            },
            {
              heading: "What It Does",
              content: [
                "Receives requests from frontend",
                "Validates input (checks for bad data)",
                "Calls appropriate stored procedures",
                "Formats data for frontend consumption",
                "Handles errors gracefully (no crashes!)",
                "Logs all activity for monitoring",
              ],
            },
            {
              heading: "Security Features",
              content: [
                "POST for sensitive data (SSNs never in URLs)",
                "Generic error messages (doesn't expose DB structure)",
                "Input validation and sanitization",
                "Timeout protection (60 second limit)",
              ],
            },
            {
              heading: "Example Code",
              code: `app.post('/api/item-inventory', async (req, res) => {
  try {
    const result = await pool.request()
      .input('ItemNumber', req.body.itemNumber)
      .execute('SP_InventoryCheck');
    res.json(result.recordset);
  } catch (error) {
    console.error('Error:', error);
    res.status(500).json({ error: 'Server error' });
  }
});`,
            },
          ],
        },
        database: {
          title: "Database Layer",
          sections: [
            {
              heading: "Connection Management (db.js)",
              content: [
                "Connection pooling: Reuse pre-opened DB connections from connection pools",
                "60-second timeout: Prevents hanging queries",
                "Automatic reconnection: Recovers from network issues",
                "Multiple requests handled simultaneously",
              ],
            },
            {
              heading: "Key Tables",
              content: [
                '<a href="/images/schema_visual_example.png" target="_blank" style="color: #0000FF; text-decoration: underline;">This schema</a> for each VAMC site: data from live files to be mapped via AWS Lambda (Python SDK) nightly',
                "Item_Master: All items with descriptions",
                "inventory_by_locations: Stock levels by station",
                "ApplianceTransIP: Transaction history (who got what)",
                "Facilities_Geo: Station names and locations",
              ],
            },
            {
              heading: "Stored Procedures",
              content: [
                "SP_InventoryCheck_Autocomplete: Fast search suggestions",
                "SP_InventoryCheck: Full inventory lookup",
                "sp_GetTopDuplicateOffenders: Main report query",
                "sp_GetTopDuplicateOffendersDetails2: Detail drill-down",
              ],
            },
            {
              heading: "Performance Optimizations",
              content: [
                "Query time reduced: 98 seconds to 5 seconds (correct indexing and pre-aggregation):",
                "Index added on ApplianceTransIP",
                "CTE used to parse dates once (not millions of times)",
                "CTEs used to pre-aggregate before joining: joining a billion rows vs few hundred thousand",
                "things like TRY_CONVERT() to gracefully handle data before crashing",
              ],
            },
            {
              heading: "Example relevant index mentioned above:",
              code: `CREATE NONCLUSTERED INDEX 
IX_ApplianceTransIP_Lookup 
ON ApplianceTransIP 
(PatShortSSN, ItemIEN, StationID, RequestDate)
INCLUDE (PatientName);
`,
            },
          ],
        },
      };

      // Tooltip functionality
      const boxes = document.querySelectorAll(".box");
      const tooltip = document.getElementById("tooltip");
      const modal = document.getElementById("modal");
      const modalBody = document.getElementById("modal-body");

      boxes.forEach((box) => {
        // Tooltip on hover
        box.addEventListener("mouseenter", (e) => {
          const tooltipText = box.getAttribute("data-tooltip");
          if (tooltipText) {
            tooltip.textContent = tooltipText;
            tooltip.style.display = "block";
          }
        });

        box.addEventListener("mousemove", (e) => {
          tooltip.style.left = e.pageX + 15 + "px";
          tooltip.style.top = e.pageY + 15 + "px";
        });

        box.addEventListener("mouseleave", () => {
          tooltip.style.display = "none";
        });

        // Modal on click
        box.addEventListener("click", () => {
          // Determine which component was clicked
          let componentType = "";
          if (box.classList.contains("user-box")) componentType = "user";
          else if (box.classList.contains("frontend-box"))
            componentType = "frontend";
          else if (box.classList.contains("backend-box"))
            componentType = "backend";
          else if (box.classList.contains("db-box")) componentType = "database";

          if (componentType) {
            showModal(componentType);
          }
        });
      });

      function showModal(componentType) {
        const details = componentDetails[componentType];
        if (!details) return;

        let html = `<h2 class="modal-title">${details.title}</h2>`;

        details.sections.forEach((section) => {
          html += `<div class="modal-section">`;
          html += `<h3>${section.heading}</h3>`;

          if (section.content) {
            html += `<ul>`;
            section.content.forEach((item) => {
              html += `<li>${item}</li>`;
            });
            html += `</ul>`;
          }

          if (section.code) {
            html += `<div class="code-block">${section.code.replace(/\n/g, "<br>")}</div>`;
          }

          html += `</div>`;
        });

        modalBody.innerHTML = html;
        modal.classList.add("active");
        document.body.style.overflow = "hidden";
      }

      function closeModal() {
        modal.classList.remove("active");
        document.body.style.overflow = "auto";
      }

      // Close modal when clicking outside
      modal.addEventListener("click", (e) => {
        if (e.target === modal) {
          closeModal();
        }
      });

      // Close modal with Escape key
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape" && modal.classList.contains("active")) {
          closeModal();
        }
      });
    </script>
  </body>
</html>
